<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mappers.postService">

    <select id="selectPostList" parameterType="Map" resultType="Map">
        SELECT /* [mappers.postService.selectPostList] 게시물 목록 조회 (본인등록게시물,좋어요한게시물,팔로우한게시물) */
               P.POST_ID           AS postId
             , P.POST_CONTENT      AS postContent
             , P.POST_HASHTAG      AS postHashtag
             , P.REG_DTM           AS regDtm
             , P.REG_ID            AS regId
             , P.UPD_DTM           AS updDtm
             , P.UPD_ID            AS updId
             , U.USER_NAME         AS userName
             , U.USER_PRF_IMG_NAME AS userPrfImgName
          FROM NB_POST P
             , NB_USER U
         WHERE P.REG_ID = U.USER_ID
               REG_ID = #{session.userId}
            OR REG_ID IN  (
                           SELECT FOLLOW_RES_ID
                             FROM NB_FOLLOW
                            WHERE FOLLOW_REQ_ID = #{session.userId}
                          )
            OR POST_ID IN (
                           SELECT POST_ID
                             FROM NB_LIKE
                            WHERE REG_ID = #{session.userId}
                          )
            OR POST_ID IN (
                           SELECT POST_ID
                             FROM NB_RECOMMENT
                            WHERE REG_ID = #{session.userId}
                          )
         ORDER BY UPD_DTM DESC
         LIMIT #{sIdx} , #{unit}
    </select>

    <select id="selectFileList" parameterType="Map" resultType="Map">
        SELECT /* [mappers.postService.selectFileList] 게시물 파일목록조회  */
               POST_ID   AS postId
             , FILE_ID   AS fileId
             , FILE_SNM  AS fileSnm
             , FILE_ONM  AS fileOnm
             , FILE_PATH AS filePath
          FROM NB_ATCH_FILE
         WHERE POST_ID = #{postId}
         ORDER BY UPD_DTM DESC
    </select>

    <select id="selectRecommentList" parameterType="Map" resultType="Map">
        SELECT /* [mappers.postService.selectRecommentList] 게시물 댓글 목록 조회  */
                R.RECOMMENT_ID       AS recommentId
              , R.RECOMMENT_CONTENT  AS recommentContent
              , R.REG_ID             AS regId
              , R.REG_DTM            AS regDtm
              , U.USER_EMAIL         AS userEmail
              , U.USER_ID            AS userId
              , U.USER_NAME          AS userName
           FROM NB_RECOMMENT R
              , NB_USER U
          WHERE R.REG_ID = U.USER_ID
            AND R.POST_ID = #{postId}
          ORDER BY R.REG_DTM DESC
    </select>

    <select id="selectUserPostList" parameterType="Map" resultType="Map">
        SELECT  /* [mappers.postService.selectUserPostList] 사용자 게시물 조회  */
               POST_ID             AS postId
             , POST_CONTENT        AS postContent
             , POST_HASHTAG        AS postHashtag
             , REG_DTM             AS regDtm
             , REG_ID              AS regId
             , UPD_DTM             AS updDtm
             , UPD_ID              AS updId
             , U.USER_NAME         AS userName
             , U.USER_PRF_IMG_NAME AS userPrfImgName
          FROM NB_POST P
             , NB_USER U
         WHERE P.REG_ID = U.USER_ID
               REG_ID = (
                         SELECT USER_ID
                           FROM NB_USER
                          WHERE USER_EMAIL = #{userEmail}
                        )
         LIMIT #{sIdx} , #{unit}
    </select>

    <insert id="insertPost" parameterMap="Map">
        INSERT INTO /* [mappers.postService.insertPost] 게시물 등록  */
               NB_POST
             (
                 POST_CONTENT
                ,POST_HASHTAG
                ,REG_ID
                ,UPD_ID
                ,REG_DTM
                ,UPD_DTM
             ) VALUES
             (   #{postContent}
                ,#{postHashtag}
                ,#{regId}
                ,#{updId}
                ,NOW()
                ,NOW()
             )
    </insert>

    <insert id="insertFile" parameterMap="Map">
        INSERT INTO /* [mappers.postService.insertFile] 게시물 첨부파일 등록  */
               NB_ATCH_FILE
             (
                 POST_ID
                ,FILE_SNM
                ,FILE_ONM
                ,FILE_TYPE
                ,FILE_PATH
                ,REG_ID
                ,UPD_ID
                ,REG_DTM
                ,UPD_DTM
             ) VALUES
             (    #{postId}
                 ,#{FILE_SNM}
                 ,#{FILE_ONM}
                 ,#{FILE_TYPE}
                 ,#{FILE_PATH}
                 ,#{session.userId}
                 ,#{session.userId}
                 ,NOW()
                 ,NOW()
	         )
    </insert>
    <insert id="mappers.postService.insertRcmd" parameterMap="Map">
        INSERT INTO /* [mappers.postService.insertRcmd] 게시물 첨부파일 등록  */
               NB_RECOMMENT
            (
               POST_ID
              ,RECOMMENT_CONTENT
              ,REG_ID
              ,UPD_ID
              ,REG_DTM
              ,UPD_DTM
            )VALUES(
               #{postId}
              ,#{recommentContent}
              ,#{session.userId}
              ,#{session.userId}
              ,NOW()
              ,NOW()
            )
    </insert>
</mapper>